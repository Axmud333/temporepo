<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Security headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>Haawall - University Assistant</title>
    <link rel="shortcut icon" href="static/images/uos-icon.ico" type="image/x-icon">
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <!-- main header -->
    <div class="header">
        <!-- hamburger menu for mobile -->
        <div class="mobile-menu-icon" id="mobileMenuToggle">☰</div>
      
        <!-- left nav links -->
        <nav class="main-nav left desktop-only">
          <a href="/" class="nav-link active">Home</a>
          <a href="about" class="nav-link">About</a>
        </nav>
      
        <!-- university logo -->
        <div class="logo"> 
            <div class="logo-icon"></div>
        </div>
      
        <!-- right side controls -->
        <nav class="main-nav right desktop-only">
          <button id="langSwitchBtn" class="lang-toggle">
            کوردی
          </button>
          <a href="contact" class="nav-link contact-btn">Contact Us</a>
        </nav>
        
        <!-- help button with question mark -->
        <button class="faq-button" id="faqButton">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
          </svg>
        </button>
        
        <!-- FAQ dropdown menu -->
        <div class="faq-dropdown" id="faqDropdown">
          <div class="faq-header">Frequently Asked Questions</div>
          <div class="faq-list" id="faqList">
            <!-- FAQ items added by javascript -->
          </div>
        </div>

        <!-- mobile language switcher -->
        <div class="mobile-controls">
          <button id="langSwitchBtnMobile" class="lang-toggle">
            کوردی
          </button>
        </div>

        <!-- mobile dropdown menu -->
        <div class="mobile-menu hidden" id="mobileMenu">
          <a href="/" class="nav-link active">Home</a>
          <a href="/about" class="nav-link">About</a>
          <a href="/contact" class="nav-link contact-btn">Contact Us</a>
        </div>
    </div>
      
    <!-- quick action buttons -->
    <div class="quick-actions">
        <div class="quick-actions-container">
            <div class="quick-action-btn" data-prompt="0">
                <div class="quick-action-title">Course Information</div>
                <div class="quick-action-text">What courses are available in Computer Engineering?</div>
            </div>
            <div class="quick-action-btn" data-prompt="1">
                <div class="quick-action-title">Campus Services</div>
                <div class="quick-action-text">When The Next Semester Starts?</div>
            </div>
            <div class="quick-action-btn" data-prompt="2">
                <div class="quick-action-title">Registration Help</div>
                <div class="quick-action-text">How do I register for courses?</div>
            </div>
            <div class="quick-action-btn" data-prompt="3">
                <div class="quick-action-title">Campus Navigation</div>
                <div class="quick-action-text">Where is the Computer Engineering building?</div>
            </div>
        </div>
    </div>

    <!-- chat area -->
    <div class="chat-container">
        <!-- welcome screen -->
        <div class="welcome-screen" id="welcomeScreen">
            <div class="welcome-logo"> 
                <img src="static/images/uoswelcomelogo.png" alt="Logo"> 
            </div>
            <h1 class="welcome-title">How can I help you today?</h1>
            <p class="welcome-subtitle">I'm Haawall, your University of Sulaimani assistant. Ask me about courses, schedules, campus info, and more.</p>
        </div>

        <!-- chat messages go here -->
        <div class="messages" id="messages"></div>
        
        <!-- typing dots animation -->
        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-avatar"></div>
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
    </div>

    <!-- message input at bottom -->
    <div class="input-area" id="inputArea">
        <div class="input-container">
            <textarea 
                class="message-input" 
                id="messageInput" 
                placeholder="Message Haawall..."
                rows="1"
                maxlength="5000"
            ></textarea>
            <button class="send-button" id="sendButton">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/>
                </svg>
            </button>
        </div>
    </div>

<script>
// Security: HTML sanitization function
function sanitizeHTML(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

// Security: Content validation
function validateMessage(message) {
    if (!message || typeof message !== 'string') return false;
    if (message.length > 5000) return false;
    
    // Block dangerous patterns
    const dangerousPatterns = [
        /<script/i,
        /javascript:/i,
        /<iframe/i,
        /<form/i,
        /<input/i,
        /on\w+\s*=/i, // Event handlers like onclick, onload
        /<object/i,
        /<embed/i,
        /<link/i,
        /<meta/i
    ];
    
    return !dangerousPatterns.some(pattern => pattern.test(message));
}

// Security: Safe text formatting (no HTML injection)
function formatMessageSafe(message) {
    // First sanitize to prevent HTML injection
    let safeMessage = sanitizeHTML(message);
    
    // Convert line breaks to <br>
    safeMessage = safeMessage.replace(/\n/g, '<br>');
    
    // Safe bold formatting - only allow simple **text** 
    safeMessage = safeMessage.replace(/\*\*([^<>]*?)\*\*/g, '<strong>$1</strong>');
    
    // Make numbered lists bold
    safeMessage = safeMessage.replace(/^(\d+\.\s)/gm, '<strong>$1</strong>');
    
    // Bullet points
    safeMessage = safeMessage.replace(/^[-•]\s/gm, '• ');
    
    // Make specific phrases bold
    safeMessage = safeMessage.replace(/^(To get the most accurate.*?):/gm, '<strong>$1:</strong>');
    safeMessage = safeMessage.replace(/^(For the most current.*?):/gm, '<strong>$1:</strong>');
    
    return safeMessage;
}

// Global variables
let currentLang = 'en';
let faqOpen = false;
let isAIResponding = false;
let isTypingComplete = false;
let sessionId = null;

// FAQ questions 
const faqQuestions = {
  en: [
    "Engineering College Foundation Building?",
    "Where are the statistic staffs?", 
    "Where is the board of department heads?",
    "When does the semester start?",
    "When is the employees' sessions?",
    "What are the library hours?",
    "What departments does the engineering college have?",
    "Where is the registration?",
    "Parallel Program Prices",
    "Where is the central cafeteria?"
  ],
  ku: [
    "بینای کۆلێژی ئەندازیاری",
    "ژمێریاری لە کوێیە؟",
    "سەرۆکایەتی لە کوێیە؟",
    "کەی وەرزی خوێندن دەستپێدەکات؟",
    "دەوامی کارمەندان کەی بۆ کایە؟",
    "کاتەکانی کتێبخانە لە کەیەوەیە؟",
    "بەشەکانی کۆلێژی ئەندازیاری چین؟ ",
    "تۆمار لەکوێیە؟ ",
    "کرێی پاراڵێلی بەشەکان چەندە؟",
    "کافتریای ناوەند لەکوێیە؟ "
  ]
};

// UI translations
const translations = {
  en: {
    switchText: "کوردی",
    welcomeTitle: "How can I help you today?",
    welcomeSubtitle: "I'm Haawall, your University of Sulaimani assistant. Ask me about courses, schedules, campus info, and more.",
    prompts: [
      { title: "Course Information", text: "What courses are available in Computer Engineering?" },
      { title: "Campus Services", text: "When Does the next semester starts??" },
      { title: "Registration Help", text: "How do I register for courses?" },
      { title: "Campus Navigation", text: "Where is the Computer Engineering building?" },
    ],
    inputPlaceholder: "Message Haawall...",
    faqHeader: "Frequently Asked Questions"
  },
  ku: {
    switchText: "English",
    welcomeTitle: "چۆن دەتوانم یارمەتیت بدەم؟",
    welcomeSubtitle: "من هاوەڵم، یارمەتیدەری زانکۆی سلێمانی. پرسیارەکانت لەسەر وانەکان، کاتی خوێندن، زانیاری زانکۆ و زیاتر بپرسە.",
    prompts: [
      { title: "زانیاری وانە", text: "وانەکانی ئەندازیاری کۆمپیوتەر چییە؟" },
      { title: "خزمەتگوزاری زانکۆ", text: "کەی دەوام دەستپێدەکاتەوە؟" },
      { title: "یارمەتیدانی تۆمارکردن", text: "چۆن تۆمار دەکەم بۆ وانەکان؟" },
      { title: "ڕێنوێنی زانکۆ", text: "بینای ئەندازیاری کۆمپیوتەر لە کوێیە؟" },
    ],
    inputPlaceholder: "...پەیامێک بنێرە بۆ هاوەڵ",
    faqHeader: "پرسیارە دووبارەکان"
  }
};

// Kurdish text detection
function detectKurdishText(text) {
  const cleanText = text.replace(/<[^>]*>/g, '');
  const kurdishPattern = /[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF]/;
  const kurdishChars = (cleanText.match(/[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF]/g) || []).length;
  const latinChars = (cleanText.match(/[a-zA-Z]/g) || []).length;
  const totalChars = kurdishChars + latinChars;
  
  if (totalChars === 0) return false;
  return (kurdishChars / totalChars) > 0.3;
}

// Input state management
function updateInputState() {
    const input = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const inputContainer = document.querySelector('.input-container');
    
    if (isAIResponding) {
        input.disabled = true;
        sendButton.disabled = true;
        inputContainer.classList.add('disabled');
        
        const originalPlaceholder = input.placeholder;
        input.setAttribute('data-original-placeholder', originalPlaceholder);
        input.placeholder = currentLang === 'ku' 
            ? '...چاوەڕێ بکە تا هاوەڵ وەڵامت دەداتەوە'
            : 'Please wait for Haawall to finish responding...';
    } else {
        input.disabled = false;
        sendButton.disabled = false;
        inputContainer.classList.remove('disabled');
        
        const originalPlaceholder = input.getAttribute('data-original-placeholder');
        if (originalPlaceholder) {
            input.placeholder = originalPlaceholder;
        } else {
            input.placeholder = translations[currentLang].inputPlaceholder;
        }
        
        input.focus();
    }
}

// SECURE typeWriter function
function typeWriterSafe(element, text, speed = 20, showCursor = true) {
    // Security: Validate and sanitize input
    if (!validateMessage(text)) {
        element.textContent = 'Message blocked for security reasons';
        return Promise.resolve();
    }
    
    element.innerHTML = '';
    let i = 0;
    
    let userHasScrolled = false;
    let isAtBottomBeforeTyping = isScrolledToBottom();
    
    const isKurdishContent = detectKurdishText(text);
    if (isKurdishContent) {
      element.classList.add('rtl-text');
      element.parentElement.classList.add('rtl-message');
    } else {
      element.classList.remove('rtl-text');
      element.parentElement.classList.remove('rtl-message');
    }
    
    isAIResponding = true;
    isTypingComplete = false;
    updateInputState();
    
    // Add cursor styles if not there
    if (!document.querySelector('#cursor-style')) {
        const style = document.createElement('style');
        style.id = 'cursor-style';
        style.textContent = `
            .typing-cursor {
                display: inline-block;
                background-color: #333;
                width: 2px;
                height: 1.2em;
                margin-left: 2px;
                animation: blink 1s infinite;
            }
            @keyframes blink {
                0%, 50% { opacity: 1; }
                51%, 100% { opacity: 0; }
            }
            .ai-response-header {
                font-weight: bold;
                font-size: 1.1em;
                margin-bottom: 8px;
                color: #2c3e50;
                border-bottom: 2px solid #3498db;
                padding-bottom: 5px;
                display: inline-block;
            }
            .message.assistant .message-content {
                line-height: 1.6;
            }
            .input-container.disabled {
                opacity: 0.6;
                pointer-events: none;
            }
            .message-input:disabled {
                background-color: #f5f5f5;
                cursor: not-allowed;
            }
            .send-button:disabled {
                background-color: #ccc;
                cursor: not-allowed;
            }
            .typing-status {
                position: absolute;
                top: -25px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(52, 152, 219, 0.1);
                color: #3498db;
                padding: 5px 15px;
                border-radius: 15px;
                font-size: 12px;
                font-weight: 500;
                white-space: nowrap;
                z-index: 100;
            }
            .rtl-text {
                direction: rtl;
                text-align: right;
                font-family: 'Segoe UI', 'Tahoma', 'Arial Unicode MS', sans-serif;
                line-height: 1.6;
            }
            .rtl-message {
                direction: rtl;
            }
            .rtl-message .message-avatar {
                order: 2;
                margin-left: 12px;
                margin-right: 0;
            }
            .rtl-message .message-content {
                order: 1;
            }
            .rtl-text ul, .rtl-text ol {
                text-align: right;
                direction: rtl;
            }
            .rtl-text li {
                text-align: right;
            }
            .message.assistant .message-content:not(.rtl-text) {
                direction: ltr;
                text-align: left;
            }
        `;
        document.head.appendChild(style);
    }
    
    // Add typing status
    const inputArea = document.getElementById('inputArea');
    const typingStatus = document.createElement('div');
    typingStatus.className = 'typing-status';
    typingStatus.id = 'typingStatus';
    typingStatus.textContent = currentLang === 'ku' ? '...هاوەڵ وەڵام دەداتەوە    ' : 'Haawall is responding...';
    inputArea.appendChild(typingStatus);
    
    const messagesContainer = document.getElementById('messages');
    let scrollTimeout;
    
    const handleScroll = () => {
        userHasScrolled = true;
        clearTimeout(scrollTimeout);
        
        scrollTimeout = setTimeout(() => {
            if (isScrolledToBottom()) {
                userHasScrolled = false;
            }
        }, 1000);
    };
    
    messagesContainer.addEventListener('scroll', handleScroll, { passive: true });
    
    function type() {
        if (i < text.length) {
            const char = text.charAt(i);
            
            // Security: Build safe formatted text
            const currentText = text.substring(0, i + 1);
            const safeFormattedText = formatMessageSafe(currentText);
            
            // Apply header styling to first line
            let finalFormattedText = safeFormattedText;
            if (i === 0 || (i > 0 && text.substring(0, i).includes('\n') && text.substring(i).trim().length > 0)) {
                const lines = finalFormattedText.split('<br>');
                if (lines.length > 0 && lines[0].trim().length > 0) {
                    lines[0] = `<div class="ai-response-header">${lines[0]}</div>`;
                    finalFormattedText = lines.join('<br>');
                }
            }
            
            element.innerHTML = finalFormattedText;
            
            if (showCursor) {
                element.innerHTML += '<span class="typing-cursor"></span>';
            }
            
            i++;
            
            let currentSpeed = speed;
            if (char === '.' || char === '!' || char === '?') {
                currentSpeed = speed * 4; 
            } else if (char === ',' || char === ';' || char === ':') {
                currentSpeed = speed * 2; 
            } else if (char === ' ') {
                currentSpeed = speed * 0.3; 
            }
            
            setTimeout(type, currentSpeed);
            
            if (isAtBottomBeforeTyping && !userHasScrolled) {
                scrollToBottom();
            }
        } else {
            isTypingComplete = true;
            messagesContainer.removeEventListener('scroll', handleScroll);
            
            const statusElement = document.getElementById('typingStatus');
            if (statusElement) {
                statusElement.remove();
            }
            
            if (showCursor) {
                setTimeout(() => {
                    let finalSafeText = formatMessageSafe(text);
                    // Apply header styling
                    const lines = finalSafeText.split('<br>');
                    if (lines.length > 0 && lines[0].trim().length > 0) {
                        lines[0] = `<div class="ai-response-header">${lines[0]}</div>`;
                        finalSafeText = lines.join('<br>');
                    }
                    element.innerHTML = finalSafeText;
                    
                    if (isAtBottomBeforeTyping && !userHasScrolled) {
                        scrollToBottom();
                    }
                    
                    isAIResponding = false;
                    updateInputState();
                }, 500); 
            } else {
                isAIResponding = false;
                updateInputState();
            }
        }
    }
    
    type();
    
    return new Promise(resolve => {
        const checkComplete = () => {
            if (i >= text.length) {
                setTimeout(() => {
                    isAIResponding = false;
                    updateInputState();
                    resolve();
                }, showCursor ? 500 : 0);
            } else {
                setTimeout(checkComplete, 100);
            }
        };
        checkComplete();
    });
}

// Utility functions
function isScrolledToBottom() {
    const messagesContainer = document.getElementById('messages');
    if (!messagesContainer) return true;
    
    const threshold = 50;
    return messagesContainer.scrollHeight - messagesContainer.scrollTop <= messagesContainer.clientHeight + threshold;
}

function toggleFAQ() {
  const dropdown = document.getElementById('faqDropdown');
  const button = document.getElementById('faqButton');
  
  faqOpen = !faqOpen;
  
  if (faqOpen) {
    dropdown.classList.add('show');
    button.style.transform = 'rotate(180deg)';
    populateFAQList();
  } else {
    dropdown.classList.remove('show');
    button.style.transform = 'rotate(0deg)';
  }
}

function populateFAQList() {
  const faqList = document.getElementById('faqList');
  faqList.innerHTML = '';
  
  const currentFaqQuestions = faqQuestions[currentLang];
  
  currentFaqQuestions.forEach((question, index) => {
    const faqItem = document.createElement('div');
    faqItem.className = 'faq-item';
    faqItem.textContent = question; // Safe: using textContent
    faqItem.addEventListener('click', () => {
      sendFAQQuestion(question);
      toggleFAQ();
    });
    faqList.appendChild(faqItem);
  });
}

function sendFAQQuestion(question) {
  if (isAIResponding) {
    return;
  }
  document.getElementById('messageInput').value = question;
  sendMessage(question);
}

function toggleMenu() {
  const menu = document.getElementById('mobileMenu');
  menu.classList.toggle('hidden');
}

function handleKeyDown(event) {
  if (event.key === 'Enter' && !event.shiftKey) {
    event.preventDefault();
    
    if (!isAIResponding) {
      sendMessage();
    }
  }
}

function adjustTextareaHeight() {
  const textarea = document.getElementById('messageInput');
  
  if (textarea.disabled) return;
  
  textarea.style.height = 'auto';
  const newHeight = Math.min(textarea.scrollHeight, 120);
  textarea.style.height = newHeight + 'px';
  
  if (isScrolledToBottom()) {
    requestAnimationFrame(() => {
        scrollToBottom();
    });
  }
}

function handleInputFocus() {
  const inputArea = document.getElementById('inputArea');
  
  if (window.innerWidth <= 768) {
    inputArea.classList.add('keyboard-open');
    
    if (isScrolledToBottom()) {
        setTimeout(() => scrollToBottom(), 100);
        setTimeout(() => scrollToBottom(), 300);
        setTimeout(() => scrollToBottom(), 500);
    }
  }
}

function handleInputBlur() {
  const inputArea = document.getElementById('inputArea');
  
  if (window.innerWidth <= 768) {
    inputArea.classList.remove('keyboard-open');
    
    if (isScrolledToBottom()) {
        setTimeout(() => {
            scrollToBottom();
        }, 400);
    }
  }
}

function sendExamplePrompt(promptIndex) {
  if (isAIResponding) {
    return;
  }
  
  const prompt = translations[currentLang].prompts[promptIndex].text;
  document.getElementById('messageInput').value = prompt;
  sendMessage(prompt);
}

// SECURE sendMessage function
function sendMessage(customMessage = null) {
  const input = document.getElementById('messageInput');
  const message = customMessage || input.value.trim();

  // Security: Validate message
  if (!validateMessage(message)) {
    const errorMsg = currentLang === 'ku'
      ? 'پەیامەکە پەسەندنەکراوە. تکایە ناوەڕۆکێکی ئاسایی بنێرە.'
      : 'Message rejected. Please send safe content only.';
    
    alert(errorMsg);
    return;
  }

  if (isAIResponding) {
    const warningMsg = currentLang === 'ku' 
      ? 'تکایە چاوەڕێ بکە تا هاوەڵ وەڵام بداتەوە'
      : 'Please wait for Haawall to finish responding';
    
    console.log(warningMsg);
    return;
  }

  if (message === '') return;

  document.getElementById('welcomeScreen').classList.add('hidden');
  
  isAIResponding = true;
  updateInputState();

  addMessageSafe(message, 'user');
  input.value = '';
  input.style.height = 'auto';

  showTypingIndicator();

  fetch('/chat', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ 
      message: message,
      session_id: sessionId
    })
  })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      hideTypingIndicator();
      
      if (data.session_id) {
        sessionId = data.session_id;
      }
      
      setTimeout(() => {
        if (data.response) {
          addMessageSafe(data.response, 'assistant');
        } else if (data.error) {
          const errorMsg = currentLang === 'ku'
            ? 'ببورە، هەڵەیەک ڕویدا: ' + data.error
            : 'I apologize, but I encountered an error: ' + data.error;
          addMessageSafe(errorMsg, 'assistant', true);
        } else {
          const unexpectedMsg = currentLang === 'ku'
            ? 'وەلامێکی نەزانراوە وەرگیرا. تکایە دواتر هەوڵبدەوە.'
            : 'I received an unexpected response. Please try again.';
          addMessageSafe(unexpectedMsg, 'assistant', true);
        }
      }, 300);
    })
    .catch(error => {
      hideTypingIndicator();
      console.error('Error:', error);
      
      setTimeout(() => {
        const connectionErrorMsg = currentLang === 'ku'
          ? 'کێشەیەک هەیە لەگەڵ بەستنی پەیوەندی. تکایە پەیوەندیدا بپشکنە و دواتر هەوڵبدەوە.'
          : 'I\'m having trouble connecting right now. Please check your connection and try again.';
        addMessageSafe(connectionErrorMsg, 'assistant', true);
      }, 300);
    })
    .finally(() => {
      if (!isAIResponding) {
        updateInputState();
      }
    });
}

// SECURE add message function
function addMessageSafe(message, sender, isError = false) {
  // Security: Validate message before displaying
  if (!validateMessage(message) && sender === 'user') {
    message = 'Message blocked for security reasons';
  }

  const messagesContainer = document.getElementById('messages');
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${sender}`;

  const avatar = document.createElement('div');
  avatar.className = 'message-avatar';
  avatar.textContent = sender === 'user' ? 'U' : '';

  const content = document.createElement('div');
  content.className = isError ? 'error-message' : 'message-content';
  
  if (sender === 'assistant' && detectKurdishText(message)) {
    content.classList.add('rtl-text');
    messageDiv.classList.add('rtl-message');
  } else {
    content.classList.remove('rtl-text');
    messageDiv.classList.remove('rtl-message');
  }
  
  messageDiv.appendChild(avatar);
  messageDiv.appendChild(content);
  messagesContainer.appendChild(messageDiv);

  if (sender === 'user') {
    // Security: Use safe formatting for user messages
    content.innerHTML = formatMessageSafe(message);
    if (isScrolledToBottom()) {
        scrollToBottom();
    }
  } else {
    // Use secure typewriter for AI responses
    typeWriterSafe(content, message, 20, true).then(() => {
      if (isScrolledToBottom()) {
          setTimeout(() => {
              scrollToBottom();
          }, 100);
      }
    });
  }
}

// Scroll chat to bottom
function scrollToBottom() {
  const messagesContainer = document.getElementById('messages');
  const inputArea = document.getElementById('inputArea');
  
  if (messagesContainer && inputArea) {
    const inputAreaHeight = inputArea.getBoundingClientRect().height;
    const extraPadding = 30;
    
    messagesContainer.style.paddingBottom = `${inputAreaHeight + extraPadding}px`;
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    if (window.innerWidth <= 768) {
      setTimeout(() => {
        if (isScrolledToBottom()) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
      }, 50);
    }
  }
}

// Show typing indicator
function showTypingIndicator() {
  const indicator = document.getElementById('typingIndicator');
  if (indicator) {
    indicator.style.display = 'flex';
    
    if (isScrolledToBottom()) {
        setTimeout(() => scrollToBottom(), 50);
        setTimeout(() => scrollToBottom(), 150);
    }
  }
}

// Hide typing indicator
function hideTypingIndicator() {
  const indicator = document.getElementById('typingIndicator');
  if (indicator) {
    indicator.style.display = 'none';
  }
  
  if (isScrolledToBottom()) {
      setTimeout(() => scrollToBottom(), 50);
  }
}

// Switch between languages
function toggleLanguage() {
  currentLang = currentLang === 'en' ? 'ku' : 'en';
  const t = translations[currentLang];

  // Update language buttons
  document.getElementById('langSwitchBtn').innerText = t.switchText;
  document.getElementById('langSwitchBtnMobile').innerText = t.switchText;
  
  // Update welcome screen
  document.querySelector('.welcome-title').innerText = t.welcomeTitle;
  document.querySelector('.welcome-subtitle').innerText = t.welcomeSubtitle;
  
  // Update input placeholder
  updateInputState();

  // Update FAQ header
  const faqHeader = document.querySelector('.faq-header');
  if (faqHeader) {
    faqHeader.textContent = t.faqHeader;
  }

  // Refresh FAQ list if open
  if (faqOpen) {
    populateFAQList();
  }

  // Update quick action buttons
  const quickActionBtns = document.querySelectorAll('.quick-action-btn');
  quickActionBtns.forEach((btn, i) => {
    btn.querySelector('.quick-action-title').innerText = t.prompts[i].title;
    btn.querySelector('.quick-action-text').innerText = t.prompts[i].text;
  });
  
  // Update typing status if it exists
  const typingStatus = document.getElementById('typingStatus');
  if (typingStatus) {
    typingStatus.textContent = currentLang === 'ku' ? '...هاوەڵ وەڵامت دەداتەوە' : 'Haawall is responding...';
  }
}

// Mobile viewport fixes
function initializeMobileFixes() {
  function setViewportHeight() {
    const vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
  }
  
  setViewportHeight();
  
  let resizeTimeout;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      setViewportHeight();
      if (isScrolledToBottom()) {
          scrollToBottom();
      }
    }, 100);
  });
  
  window.addEventListener('orientationchange', () => {
    setTimeout(() => {
      setViewportHeight();
      if (isScrolledToBottom()) {
          scrollToBottom();
      }
    }, 700); 
  });
  
  let initialViewportHeight = window.innerHeight;
  let keyboardOpen = false;
  
  window.addEventListener('resize', () => {
    const currentHeight = window.innerHeight;
    const heightDifference = initialViewportHeight - currentHeight;
    
    if (heightDifference > 150 && !keyboardOpen) {
      keyboardOpen = true;
      document.body.classList.add('keyboard-open');
      if (isScrolledToBottom()) {
          setTimeout(() => scrollToBottom(), 300);
          setTimeout(() => scrollToBottom(), 600);
      }
    } else if (heightDifference < 150 && keyboardOpen) {
      keyboardOpen = false;
      document.body.classList.remove('keyboard-open');
      if (isScrolledToBottom()) {
          setTimeout(() => scrollToBottom(), 300);
          setTimeout(() => scrollToBottom(), 600);
      }
    }
  });
}

// iOS Safari fixes
function initializeIOSFixes() {
  const viewportMeta = document.querySelector('meta[name="viewport"]');
  if (viewportMeta) {
    viewportMeta.content = 'width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no, maximum-scale=1.0';
  }
  
  document.addEventListener('focusin', function(e) {
    if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') {
      if (isScrolledToBottom()) {
          setTimeout(() => scrollToBottom(), 100);
          setTimeout(() => scrollToBottom(), 400);
          setTimeout(() => scrollToBottom(), 700);
      }
    }
  });
  
  document.addEventListener('focusout', function(e) {
    if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') {
      if (isScrolledToBottom()) {
          setTimeout(() => scrollToBottom(), 300);
      }
    }
  });
}

// Android fixes
function initializeAndroidFixes() {
  let originalHeight = window.innerHeight;
  
  window.addEventListener('resize', function() {
    const currentHeight = window.innerHeight;
    const diff = originalHeight - currentHeight;
    
    if (diff > 150) {
      document.body.style.paddingBottom = '0px';
      if (isScrolledToBottom()) {
          setTimeout(() => scrollToBottom(), 100);
      }
    } else {
      document.body.style.paddingBottom = '';
      if (isScrolledToBottom()) {
          setTimeout(() => scrollToBottom(), 100);
      }
    }
  });
}

// Close FAQ when clicking outside
document.addEventListener('click', function(event) {
  const dropdown = document.getElementById('faqDropdown');
  const button = document.getElementById('faqButton');
  
  if (faqOpen && !dropdown.contains(event.target) && !button.contains(event.target)) {
    toggleFAQ();
  }
});

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function () {
  // Ensure input starts correctly
  isAIResponding = false;
  updateInputState();
  
  document.getElementById('messageInput').focus();
  
  // Add event listeners (secure way without inline handlers)
  document.getElementById('mobileMenuToggle').addEventListener('click', toggleMenu);
  document.getElementById('langSwitchBtn').addEventListener('click', toggleLanguage);
  document.getElementById('langSwitchBtnMobile').addEventListener('click', toggleLanguage);
  document.getElementById('faqButton').addEventListener('click', toggleFAQ);
  document.getElementById('sendButton').addEventListener('click', sendMessage);
  document.getElementById('messageInput').addEventListener('keydown', handleKeyDown);
  document.getElementById('messageInput').addEventListener('input', adjustTextareaHeight);
  document.getElementById('messageInput').addEventListener('focus', handleInputFocus);
  document.getElementById('messageInput').addEventListener('blur', handleInputBlur);
  
  // Add event listeners for quick action buttons
  document.querySelectorAll('.quick-action-btn').forEach((btn, index) => {
    btn.addEventListener('click', () => sendExamplePrompt(index));
  });
  
  // Add styling to prevent message cutoff
  const style = document.createElement('style');
  style.textContent = `
    .messages {
      padding-bottom: 140px !important;
      scroll-behavior: smooth;
    }
    
    .chat-container {
      padding-bottom: 0 !important;
      position: relative;
    }
    
    .message:last-child {
      margin-bottom: 20px !important;
    }
    
    .input-area {
      position: fixed !important;
      bottom: 0 !important;
      left: 0 !important;
      right: 0 !important;
      z-index: 1000 !important;
      background: white !important;
      border-top: 1px solid #eee !important;
      padding: 1rem !important;
    }
    
    @media (max-width: 768px) {
      .messages {
        padding-bottom: 160px !important;
      }
      
      .keyboard-open .messages {
        padding-bottom: 200px !important;
      }
      
      .input-area {
        padding: 0.75rem !important;
      }
    }
  `;
  document.head.appendChild(style);
  
  // Mobile fixes
  if (window.innerWidth <= 768) {
    initializeMobileFixes();
  }
  
  // iOS fixes
  if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
    initializeIOSFixes();
  }
  
  // Android fixes
  if (navigator.userAgent.toLowerCase().indexOf('android') > -1) {
    initializeAndroidFixes();
  }
  
  // Initial scroll setup
  if (isScrolledToBottom()) {
      setTimeout(() => scrollToBottom(), 100);
      setTimeout(() => scrollToBottom(), 300);
      setTimeout(() => scrollToBottom(), 500);
  }
});
</script>
</body>
</html>